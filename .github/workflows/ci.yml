name: CI

on:
    push:
        branches: [ "master" ]
    pull_request:
        branches: [ "master" ]

jobs:
    build-and-test:
        runs-on: ubuntu-latest

        services:
            mysql:
                image: mysql:8.0
                env:
                    MYSQL_DATABASE: futevent_test
                    MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="mysqladmin ping"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Build PHP Docker image
              run: docker build -t futevent-php -f docker/php/Dockerfile .

            - name: Install Composer dependencies
              run: |
                  docker run --rm \
                    -v ${{ github.workspace }}:/var/www/app \
                    -e APP_ENV=test \
                    futevent-php \
                    composer install --no-interaction --prefer-dist

            - name: Prepare test database
              run: |
                  docker run --rm \
                    -v ${{ github.workspace }}:/var/www/app \
                    -e APP_ENV=test \
                    -e DATABASE_URL="mysql://root:@mysql:3306/futevent?serverVersion=8.0" \
                    --network ${{ job.services.mysql.network }} \
                    futevent-php \
                    php bin/console doctrine:schema:update --force

            - name: Run PHPUnit
              run: |
                  docker run --rm \
                    -v ${{ github.workspace }}:/var/www/app \
                    -e APP_ENV=test \
                    -e DATABASE_URL="mysql://root:@mysql:3306/futevent_test?serverVersion=8.0" \
                    --network ${{ job.services.mysql.network }} \
                    futevent-php \
                    php bin/phpunit --testdox
